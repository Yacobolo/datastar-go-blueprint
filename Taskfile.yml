version: '3'

env:
  STATIC_DIR: web/resources/static
  # cssgen common parameters
  CSSGEN_SOURCE: web/ui/styles
  CSSGEN_OUTPUT_DIR: internal/ui
  CSSGEN_PACKAGE: ui
  CSSGEN_INCLUDE: "layers/components/**/*.css,layers/utilities.css,layers/base.css"
  CSSGEN_LINT_PATHS: "internal/features/**/*.templ,internal/features/**/*.go"

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  # ====================
  # Code Generation (generate:*)
  # ====================
  # These tasks generate Go code from source files:
  # - generate:templ : *.templ → *_templ.go
  # - generate:sqlc  : *.sql → type-safe queries
  # - generate:css   : *.css → type-safe constants
  # ====================

  generate:templ:
    desc: Generate templ templates
    sources:
      - internal/features/**/*.templ
    generates:
      - internal/features/**/*_templ.go
    cmds:
      - templ generate

  # ====================
  # Asset Bundling (build:web:*)
  # ====================
  # These tasks bundle frontend assets for deployment
  # ====================

  build:web:assets:
    desc: Bundle all web assets (CSS + JS/TS) with esbuild
    sources:
      - web/ui/styles/**/*.css
      - web/ui/components/**/*.ts
      - web/ui/libs/**/*.ts
      - web/ui/src/**/*.ts
    generates:
      - web/resources/static/styles.css
      - web/resources/static/libs/*.js
      - web/resources/static/theme-switcher.js
    cmds:
      - go run cmd/server/build/main.go

  build:web:
    desc: Build all web assets
    deps:
      - build:web:assets

  # ====================
  # Production Build
  # ====================

  build:
    desc: Build production binary
    deps:
      - generate:all
      - build:web
    cmds:
      - go build -o bin/server cmd/server/main.go

  # ====================
  # Live Tasks (Development with Watchers)
  # ====================

  live:templ:
    desc: Watch and regenerate templ templates
    cmds:
      - templ generate -watch

  live:web:assets:
    desc: Watch and bundle all web assets (CSS + JS/TS) with esbuild
    cmds:
      - go run cmd/server/build/main.go -watch

  live:server:
    desc: Run server with Air (hot reload)
    cmds:
      - air

  live:
    desc: Start all watchers (run in separate terminals or use tmux/tmuxinator)
    cmds:
      - echo "Development Mode - Run these in separate terminals:"
      - echo "  1. task live:templ"
      - echo "  2. task live:web:assets"
      - echo "  3. task live:server"
      - echo ""
      - echo "Or use task dev (simplified, Air handles watchers)"

  # ====================
  # Development Commands
  # ====================

  dev:
    desc: Start development server with live reload
    aliases: [watch]
    deps:
      - generate:all
      - build:web:assets
    cmds:
      - air

  # ====================
  # Download External Assets
  # ====================

  # download:libs:
  #   desc: Download external JavaScript libraries
  #   sources:
  #     - cmd/server/downloader/main.go
  #   generates:
  #     - web/resources/static/datastar/datastar.js
  #   cmds:
  #     - go run cmd/server/downloader/main.go
  # Note: Commented out - project uses CDN for Datastar (see base.templ)

  # ====================
  # Code Generation - Meta Task
  # ====================

  generate:all:
    desc: Run all code generators (sqlc, cssgen, templ)
    deps:
      - generate:sqlc
      - generate:css
      - generate:templ

  generate:sqlc:
    desc: Generate type-safe database code from SQL
    sources:
      - internal/store/queries/*.sql
      - internal/store/migrations/*.sql
    generates:
      - internal/store/queries/*.go
    cmds:
      - sqlc generate

  generate:css:
    desc: Generate type-safe CSS constants from CSS files
    sources:
      - web/ui/styles/**/*.css
    generates:
      - internal/ui/styles*.gen.go
    cmds:
      - cssgen -source ${CSSGEN_SOURCE} -output-dir ${CSSGEN_OUTPUT_DIR} -package ${CSSGEN_PACKAGE} -include "${CSSGEN_INCLUDE}"

  # ====================
  # CSS Linting
  # ====================

  css:lint:
    desc: Lint CSS usage (golangci-lint style - issues only)
    cmds:
      - cssgen -lint-only -source ${CSSGEN_SOURCE} -output-dir ${CSSGEN_OUTPUT_DIR} -package ${CSSGEN_PACKAGE} -include "${CSSGEN_INCLUDE}" -lint-paths "${CSSGEN_LINT_PATHS}"

  css:lint:full:
    desc: Lint with statistics and Quick Wins (planning refactors)
    cmds:
      - cssgen -lint-only -output-format full -source ${CSSGEN_SOURCE} -output-dir ${CSSGEN_OUTPUT_DIR} -package ${CSSGEN_PACKAGE} -include "${CSSGEN_INCLUDE}" -lint-paths "${CSSGEN_LINT_PATHS}"

  css:report:
    desc: Generate CSS adoption report (statistics only, no issues)
    cmds:
      - cssgen -lint-only -output-format summary -source ${CSSGEN_SOURCE} -output-dir ${CSSGEN_OUTPUT_DIR} -package ${CSSGEN_PACKAGE} -include "${CSSGEN_INCLUDE}" -lint-paths "${CSSGEN_LINT_PATHS}"

  css:report:md:
    desc: Export CSS report to Markdown (for GitHub issues, wikis)
    cmds:
      - cssgen -lint-only -output-format markdown -source ${CSSGEN_SOURCE} -output-dir ${CSSGEN_OUTPUT_DIR} -package ${CSSGEN_PACKAGE} -include "${CSSGEN_INCLUDE}" -lint-paths "${CSSGEN_LINT_PATHS}" > css-report.md
      - echo "Report saved to css-report.md"

  # ====================
  # Database Commands
  # ====================

  db:reset:
    desc: Reset database (DESTRUCTIVE)
    prompt: This will delete all data. Continue?
    cmds:
      - rm -f data/*.db data/*.db-*
      - echo "Database reset complete"

  # ====================
  # Testing & Linting
  # ====================

  test:
    desc: Run all tests
    cmds:
      - go test -v ./...

  test:coverage:
    desc: Run tests with coverage
    cmds:
      - go test -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html

  lint:
    desc: Run Go linters
    cmds:
      - golangci-lint run

  check:
    desc: Run tests, lint, and CSS lint
    cmds:
      - task: test
      - task: lint
      - task: css:lint

  # ====================
  # Cleanup
  # ====================

  clean:
    desc: Clean generated files and build artifacts
    cmds:
      - rm -rf bin/
      - rm -rf tmp/
      - rm -rf web/resources/static/*
      - find . -name '*_templ.go' -delete
      - rm -f internal/ui/styles*.gen.go

  # ====================
  # Tools Installation
  # ====================

  tools:install:
    desc: Install development tools
    cmds:
      - go install github.com/a-h/templ/cmd/templ@latest
      - go install github.com/air-verse/air@latest
      - go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest
      - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
      - go install github.com/yacobolo/cssgen/cmd/cssgen@latest

  tools:check:
    desc: Check if required tools are installed
    cmds:
      - |
        for tool in templ air sqlc golangci-lint cssgen; do
          if command -v $tool &> /dev/null; then
            echo "✓ $tool installed"
          else
            echo "✗ $tool missing - run 'task tools:install'"
          fi
        done
